<view class="container">
    <top-bar class="text-white">
        <view class="text-center f-s-16 f-w-bold">{{hotel.hotelName}}</view>
    </top-bar>
    <scroll-view class="f-s-14 text-grey1 flex-1 h-1" scroll-y="{{true}}">
        <!-- 房间信息 -->
        <view class="r-t-l-12 r-t-r-12 p-16 p-b-6 room-info m-t-20">
            <view class="d-flex m-b-6">
                <text class="flex-1 f-w-bold f-s-16">{{room.roomName}}</text>
                <text class="text-primary f-s-12" bindtap="throttleOpenRoomDetailPopup">房型详情</text>
            </view>
            <view class="d-flex align-items-center m-b-6">
                <view class="f-w-bold f-s-16">
                    <date-format class=" m-r-4" value="{{roomRequestParams.checkInDate}}" format="MMMdo" />
                    <text>{{checkInDateAlias}}</text>
                </view>
                <text class="text-primary f-s-12 m-x-16 b-1 b-primary r-full p-x-8">
                    <text>{{totalDays}}晚</text>
                </text>
                <view class="f-w-bold f-s-16">
                    <date-format class=" m-r-4" value="{{roomRequestParams.checkOutDate}}" format="MMMdo" />
                    <text>{{checkOutDateAlias}}</text>
                </view>
            </view>
            <view class="text-grey2 f-s-12 m-b-6">
                <text wx:if="{{room.wifi}}">
                    <text>{{ room.wifi }}</text>
                    <text class="m-x-8 text-grey10">|</text>
                </text>
                <text>{{ ratePlan.windowType }}</text>
                <text class="m-x-8 text-grey10">|</text>
                <text>{{ ratePlan.breakfast}}</text>
            </view>
            <view class="text-green2 d-flex f-s-12">
                <view class="m-r-12">
                    <iconfont icon="return-free" class="m-r-4" />
                    <text>{{ratePlan.returnRule}}</text>
                </view>
                <view wx:if="{{room.confirmImmediately}}">
                    <iconfont icon="confirm-quickly" class="m-r-4" />
                    <text>立即确认</text>
                </view>
            </view>
            <view class="m-t-10 p-8 p-b-12 r-4 bg-grey9 f-s-12">
                <view class="f-w-bold m-b-4">
                    <iconfont icon="fill-exclamation" class="text-red2 m-r-8" />
                    <text>订房必读</text>
                </view>
                <view class="m-b-4 d-flex">
                    <text class="m-r-8">•</text>
                    <text>预订提示：订单需等酒店或供应商确认后生效，订单确认结果以特航短信或邮件通知为准，如订单不确认将全额退款至您的付款账户。</text>
                </view>
            </view>
        </view>
        <view class="bg-grey9 p-t-6">
            <!-- 因公因私 -->
            <view class="bg-white m-b-6 p-x-16 p-y-12 d-flex" wx:if="{{travelTypeChangeable}}">
                <text class="flex-1 f-w-bold">出行类型</text>
                <view class="d-flex flex-3">
                    <view class="flex-1 d-flex align-items-center" bindtap="throttleChangeTravelType" data-type="{{travelTypes.OnBusiness}}">
                        <image class="icon-16 " src="{{ isOnBusiness ? checkboxIcons.checked: checkboxIcons.unchecked }}" />
                        <text class="f-w-bold m-l-16 {{ isOnBusiness ? 'text-primary' : '' }}">
                            <text>因公</text>
                        </text>
                    </view>
                    <view class="flex-1 d-flex align-items-center" bindtap="throttleChangeTravelType" data-type="{{travelTypes.OnPrivate}}">
                        <image class="icon-16 " src="{{ !isOnBusiness ?  checkboxIcons.checked: checkboxIcons.unchecked }}" />
                        <text class="f-w-bold m-l-16 {{ !isOnBusiness ? 'text-primary' : '' }}">
                            <text>因私</text>
                        </text>
                    </view>
                </view>
            </view>
            <include src="./biz-form.wxml" wx:if="{{isOnBusiness}}" />
            <include src="./personal-form.wxml" wx:else />
        </view>
        <view class="p-t-18 p-b-36 text-center">
            <image src="{{OSSPrefix}}/hotel/hotel-ad@2x.png" style="width: 632rpx;height: 224rpx;" />
        </view>
    </scroll-view>
    <view class="footer">
        <view class="bg-white p-l-16 p-r-10  d-flex align-items-center wrapper">
            <text class="flex-1 text-orange1 f-w-bold">
                <text class="f-s-14 m-r-4">¥</text>
                <text class="f-s-22 ">{{totalFee}}</text>
            </text>
            <text class="text-primary f-s-12 p-x-10" bindtap="handleFeeDetail">明细</text>
            <view>
                <button class="f-s-16" bindtap="throttleSubmit" wx:if="{{isOnBusiness}}">
                    提交订单
                </button>
                <button class="f-s-16" bindtap="throttleSubmitPersonalOrder" wx:else>提交订单</button>
            </view>
        </view>
        <view class="fee-detail-wrapper" wx:if="{{feeDetailPopVisible}}">
            <view class="overlay" bindtap="handleFeeDetail"></view>
            <view class="r-t-l-8 r-t-r-8 bg-white p-l-16 p-r-10 p-y-20 text-grey1 f-s-14 content {{feeDetailPopVisible?'activated':''}}">
                <view class="d-flex">
                    <view class="f-w-bold">费用明细</view>
                    <view class="flex-1 text-right">
                        <text class="f-s-12">{{totalDays}}晚，{{roomCount}}间共</text>
                        <text class="text-orange1">
                            <text class="f-s-12 m-x-2">¥</text>
                            <text class="f-s-15">{{totalFee}}</text>
                        </text>
                    </view>
                </view>
                <view class="text-grey2 d-flex f-s-12 m-t-8" wx:for="{{ratePlan.dayPrices}}" wx:key="index">
                    <view>
                        <date-format value="{{item.date}}" format="MM-dd" />
                        <text class="m-l-8">房费</text>
                    </view>
                    <view class="flex-1 text-right">￥{{item.salesAmount}} x {{roomCount}}</view>
                </view>
                <block wx:if="{{ratePlan.protocolCode}}">
                    <view class="text-grey2 d-flex f-s-12 m-t-8" wx:if="{{trusteeFeeDetail}}">
                        <view>托管费</view>
                        <!-- 按照间夜收取时：配置托管费 * 天数 * 房间数 -->
                        <view class="flex-1 text-right" wx:if="{{trusteeFeeDetail.chargeType === 'RoomNights'}}">
                            ￥{{trusteeFeeDetail.trusteeFee}}  x {{totalDays}} x {{roomCount}}
                        </view>
                        <!-- 按照订单比例收取时：房费 * 配置托管费比例 -->
                        <view class="flex-1 text-right" wx:if="{{trusteeFeeDetail.chargeType === 'Percentage'}}">
                            ￥{{roomFeeCount}}  x {{trusteeFeeDetail.trusteeFee}}%
                        </view>
                    </view>
                </block>
                <block wx:else>
                    <view class="text-grey2 d-flex f-s-12 m-t-8" wx:if="{{serviceFee}}">
                        <view>系统使用费</view>
                        <view class="flex-1 text-right">
                            ￥{{serviceFee}} x {{totalDays}} x {{roomCount}}
                        </view>
                    </view>
                </block>
            </view>
        </view>
    </view>
</view>
<van-popup show="{{roomDetailPopupVisible }}" round="true" position="bottom" lock-scroll="true" bind:close="throttleCloseRoomDetailPopup" closeable>
    <room-detail-popup room="{{room}}" ratePlan="{{ratePlan}}"></room-detail-popup>
</van-popup>
<loading wx:if="{{isLoading}}" title="{{loadingTitle}}" />
<van-popup show="{{ latestTimesPopup }}" round closeable position="bottom" custom-style="height: 700rpx" bind:close="throttleCloseLatestTimes">
    <view class="d-flex flex-direction-column f-s-14 text-grey1 h-full overrun-popup">
        <view class="p-t-18">
            <view class="f-w-bold f-s-16 text-center">预计到店时间</view>
            <view class="text-grey3 f-s-12 text-center m-t-8 p-b-10 b-b-1 b-grey7">
                <text>房间整晚保留，14:00前到店可能需要等房</text>
            </view>
        </view>
        <scroll-view class="flex-1 h-1" scroll-y="{{true}}">
            <view class="p-y-12 text-center b-b-1 b-grey7 relative {{item===formData.latestArrivalTime?'text-primary':''}}" wx:for="{{latestTimes}}" wx:key="index" data-value="{{item}}" bindtap="throttleLatestArrivalTime">
                <text>{{item}}</text>
                <iconfont icon="selected" wx:if="{{item===formData.latestArrivalTime}}" class="absolute f-s-10 h-10" style="top:0;bottom:0;right:24rpx;margin:auto" />
            </view>
        </scroll-view>
    </view>
</van-popup>
<pay-center payModalProps="{{payModalProps}}" bind:success="throttlePaySuccess" bind:cancel="throttlePayCancel"></pay-center>
<van-dialog confirm-button-color="#3642ff" confirm-button-text="确认切换" show="{{bizTypeDialog}}" title="切换为因公出行后" use-slot show-cancel-button="true" bind:confirm="throttleConfirmBizType">
    <view class="m-y-20 text-grey2 p-x-24 f-s-14">
        <view>·入住人为公司员工，不会新增到我的常用旅客</view>
        <view>·支付方式根据公司配置</view>
        <view>·授信支付的公司将统一开发票到公司</view>
        <view>·可能因为收取系统使用费导致总价格略有变动</view>
        <view>·请注意公司的差旅标准</view>
    </view>
</van-dialog>
<van-dialog confirm-button-color="#3642ff" confirm-button-text="确认切换" show="{{personalTypeDialog}}" title="切换为因私出行后" use-slot show-cancel-button="true" bind:confirm="throttleConfirmPersonalType">
    <view class="m-y-20 text-grey2 p-x-24 f-s-14">
        <view>·入住人为我的常用旅客，无法选择公司员工</view>
        <view>·支付方式为个人支付</view>
        <view>·需要报销请填写发票信息</view>
    </view>
</van-dialog>
<!-- popup 必须在最外层。否则 iOS 真机上会显示不全，被 footer 遮挡住了 -->
<van-popup wx:if="{{isOnBusiness}}" show="{{ overrunReasonPopup }}" round closeable position="bottom" custom-style="height: 640rpx" bind:close="throttleCloseOverrunReason">
    <view class="d-flex flex-direction-column f-s-14 text-grey1 h-full overrun-popup">
        <view class="p-y-18">
            <view class="f-w-bold f-s-16 text-center">选择超标原因</view>
        </view>
        <scroll-view class="flex-1 h-1 text-grey2" scroll-y="{{true}}">
            <view class="p-x-32">
                <view class="m-b-12 d-flex" wx:for="{{policyConfig.hotelOverrunReason.optionItems}}" wx:key="index" data-value="{{item}}" bindtap="throttleOverrunOption">
                    <iconfont wx:if="{{overrunReasonOption!==item}}" icon="radio-unselected" class="text-grey4" />
                    <iconfont wx:else icon="radio-selected" class="text-primary" />
                    <text class="flex-1 m-l-12">{{item}}</text>
                </view>
                <view class="m-b-12" wx:if="{{policyConfig.hotelOverrunReason.supportItemOthers}}">
                    <view bindtap="throttleOverrunOther">
                        <iconfont wx:if="{{!overrunReasonIsOther}}" icon="radio-unselected" class="text-grey4" />
                        <iconfont wx:else icon="radio-selected" class="text-primary" />
                        <text class="flex-1 m-l-12">其他</text>
                    </view>
                    <teh-textarea wx:if="{{overrunReasonIsOther}}" classNames="w-full h-86 b-1 r-4 b-grey7 m-t-12 p-8" value="{{overrunOtherReasonContent}}" bind:input="handleOverrunOtherReasonContentInput"></teh-textarea>
                </view>
            </view>
        </scroll-view>
        <view class="footer p-y-16 p-x-10">
            <button bindtap="throttleConfirmOverrunReason">确定</button>
        </view>
    </view>
</van-popup>