<view class="hotel-container d-flex flex-direction-column text-grey1">
    <view>
        <top-bar backToFirstPage="{{backToFirstPage}}" class="text-white">
            <view class="text-center f-s-16 f-w-bold">订单详情</view>
        </top-bar>
        <view class="order-base-info">
            <view class="base-info-item f-s-24">
                <view class="f-w-bold">
                    <dict-transform dict="FlightOrderStatus" code="{{orderDetail.status}}"></dict-transform>
                </view>
                <view class="text-right d-flex align-items-center" bindtap="handleShowFeeDetail">
                    <view class="f-s-16">￥</view>
                    <view>{{orderDetail.paymentAmount}}</view>
                    <iconfont icon="tip" class="f-s-14 m-l-4"></iconfont>
                </view>
            </view>
            <view class="base-info-item">
                <view class="f-s-15 f-w-bold flex-1">订单号：{{orderDetail.bigOrderNo}}</view>
                <view class="text-ellipsis text-right f-s-12 m-l-auto d-flex" bindtap="throttleShowPolicyAndBaggage">
                    <view class="m-r-16">退改签规则</view>
                    <view>行李额</view>
                </view>
            </view>
            <view class="operate-btn-group">
                <view class="btn m-x-3" bindtap="handleCancel" wx:if="{{flightOrderOperation.canBeCanceled}}">
                    取消
                </view>
                <view class="btn m-x-3" bindtap="handleReturn" wx:if="{{flightOrderOperation.canBeReturned}}">
                    退票
                </view>
                <!-- <view class="btn orange-btn m-x-3" bindtap="handlePayment" wx:if="{{flightOrderOperation.canBePaid==false}}">
                        支付
                    </view> -->
                <!-- <view class="btn orange-btn m-x-3" bindtap="handlePayment" wx:if="{{flightOrderOperation.canBeChanged}}">
                        改签
                    </view> -->
                <view class="btn orange-btn m-x-3" bindtap="throttleCheckIn" wx:if="{{canCheckIn}}">
                    代办值机
                </view>
            </view>
        </view>
    </view>
    <scroll-view scroll-y="{{true}}" class="flex-1 h-1">
        <view class="content">
            <view class="bg-container">
                <!-- 航班信息 -->
                <view class="bg-white p-y-14 p-x-16 relative">
                    <view wx:if="{{!isSK}}" class="order-travel-bg">
                        <image src="{{orderTravelTypeImage[orderDetail.travelType]}}" lazy-load="true" />
                    </view>
                    <view class="d-flex justify-content-sp-bw ">
                        <view class="d-flex align-items-center">
                            <view class="f-s-14 f-w-bold">航班信息</view>
                        </view>
                        <view class="d-flex align-items-center" bindtap="handleToggleRouteDetail">
                            <view class="f-s-12 text-grey3 m-r-10">
                                {{routeDetailUnfolded ? '收起' : '展开'}}
                            </view>
                            <view class="{{routeDetailUnfolded ? 'triangle-up' : 'triangle-down'}}"></view>
                        </view>
                    </view>
                    <block wx:for="{{orderDetail.routes}}" wx:for-item="route" wx:for-index="routeIndex" wx:key="index">
                        <view wx:for="{{route.segments}}" wx:for-item="seg" wx:key="index">
                            <view class="d-flex f-s-12 m-t-20 f-w-bold align-items-center">
                                <view wx:if="{{routeIndex===0}}" class="bg-btn-primary text-white m-r-8 f-s-11 p-y-2 p-x-8 r-full">
                                    {{isRoundTrip?'去程':'单程'}}
                                </view>
                                <view wx:else class="bg-linear-green text-white m-r-8 f-s-11 p-y-2 p-x-8 r-full">
                                    返程
                                </view>
                                <view>
                                    <date-format value="{{seg.departureDateTime}}" />
                                    <date-format value="{{seg.departureDateTime}}" format="E" class="m-x-4" />
                                    <text>{{seg.departureCityName}}</text>
                                    <text class="m-x-2">-</text>
                                    <text>{{seg.arrivalCityName}}</text>
                                </view>
                                <view class="m-l-auto">
                                    <date-format value="{{seg.departureDateTime}}" format="HH:mm" />
                                    出发
                                </view>
                            </view>
                            <view class="d-flex align-items-stretch f-s-16 m-t-20" wx:if="{{routeDetailUnfolded}}">
                                <view class="d-flex flex-direction-column text-center">
                                    <view class="f-w-bold">
                                        <date-format value="{{seg.departureDateTime}}" format="HH:mm" />
                                    </view>
                                    <view class="f-s-11 text-grey3 m-y-12">
                                        <duration value="{{seg.duration}}"></duration>
                                    </view>
                                    <view class="f-w-bold">
                                        <date-format value="{{seg.arrivalDateTime}}" format="HH:mm" />
                                    </view>
                                </view>
                                <view class="p-10">
                                    <view class="bg-grey6 w-3 r-full h-full"></view>
                                </view>
                                <view class="d-flex flex-direction-column justify-content-sp-bw">
                                    <view class="f-w-bold">
                                        {{seg.departureAirportName}}
                                        <block wx:if="{{seg.departureTerminal}}">
                                            {{seg.departureTerminal}}
                                        </block>
                                    </view>
                                    <view class="f-w-bold">
                                        {{seg.arrivalAirportName}}
                                        <block wx:if="{{seg.arrivalTerminal}}">
                                            {{seg.arrivalTerminal}}
                                        </block>
                                    </view>
                                </view>
                                <view class="m-l-auto f-s-11 text-right">
                                    <view>{{seg.displayBunkPrice.bunkName}}</view>
                                    <view class="text-grey3">
                                        <view class="d-flex align-items-center">
                                            <airline-thumbnail class="w-12 h-12 d-flex m-r-2" airlineCode="{{seg.airline}}" />
                                            <view>{{seg.airlineName}}{{seg.flightNo}}</view>
                                        </view>
                                        <view>{{seg.planeType}}</view>
                                        <view>餐食：{{ seg.meal }}</view>
                                    </view>
                                </view>
                            </view>
                        </view>
                    </block>
                </view>
                <!-- 乘机人信息 -->
                <view class="customer-info m-b-8">
                    <view class="d-flex justify-content-sp-bw">
                        <view class="d-flex align-items-center">
                            <view class="f-s-14 f-w-bold">乘机人信息</view>
                        </view>
                        <view class="d-flex align-items-center" bindtap="handleToggleGuestList">
                            <view class="f-s-12 text-grey3 m-r-10">
                                {{psgDetailUnfolded ? '收起' : '展开'}}
                            </view>
                            <view class="{{psgDetailUnfolded ? 'triangle-up' : 'triangle-down'}}"></view>
                        </view>
                    </view>
                    <view class="customer-list" wx:if="{{psgDetailUnfolded}}">
                        <block wx:for="{{orderDetail.passengers}}" wx:for-item="psg" wx:key="passengerId">
                            <view class="customer-item f-s-12" data-psg="{{psg}}" bindtap="handleGuestDetail">
                                <view class="d-flex align-items-center">
                                    <view class="f-w-bold">乘机人{{index + 1}}</view>
                                    <view class="m-l-32">
                                        <view>
                                            {{psg.passengerName}}
                                            <block wx:if="{{!isSK && psg.belongedDeptName}}">
                                                {{psg.belongedDeptName}}
                                            </block>
                                        </view>
                                        <view class="text-grey3 d-flex">
                                            <dict-transform dict="DocType" code="{{psg.docType}}"></dict-transform>
                                            <view class="m-l-8">{{psg.docNo}}</view>
                                        </view>
                                    </view>
                                </view>
                                <view>
                                    <van-icon name="arrow" color="#999999" />
                                </view>
                            </view>
                        </block>
                    </view>
                    <view class="d-flex f-s-12 m-t-16" wx:else>
                        <view class="text-grey3 m-r-8">乘机人</view>
                        <view class="m-r-10" wx:for="{{orderDetail.passengers}}" wx:for-item="guest" wx:key="index">
                            <view class="d-inline">{{guest.passengerName}}</view>
                        </view>
                    </view>
                </view>
                <!-- 保险信息 -->
                <view class="p-y-14 p-x-16 bg-white m-b-8" wx:if="{{insurances && insurances.length}}" bindtap="handleToInsurance">
                    <view class="f-s-14 f-w-bold">已购产品</view>
                    <view class="d-flex m-t-14 f-s-12 ">
                        <view class="text-grey3">保险</view>
                        <view class="flex-1 d-flex justify-content-sp-bw align-items-center">
                            <view class="flex-1 m-l-64">
                                <view wx:for="{{insurances}}" wx:for-item="insurance" wx:key="insuranceId">
                                    <dict-transform code="{{insurance.insuranceName}}" dict="InsuranceType"></dict-transform>
                                    ¥{{insurance.totalPrice}} x {{orderDetail.insuranceCount}} 份
                                </view>
                            </view>
                            <iconfont class="text-grey3" icon="arrow-right"></iconfont>
                        </view>
                    </view>
                </view>
                <!-- 自定义字段 -->
                <view class="customize-info d-flex" wx:if="{{orderDetail.customizeData}}">
                    <view class="label f-s-14 f-w-bold ">{{orderDetail.customizeFieldName}}</view>
                    <view class="f-s-14">{{orderDetail.customizeData}}</view>
                </view>
                <view class="contact-info m-b-8 f-s-14">
                    <view class="f-w-bold m-b-12">联系人信息</view>
                    <view class="cell">
                        <view class="label f-w-bold">{{orderDetail.contactInfo.name}}</view>
                        <view>{{orderDetail.contactInfo.mobile}}</view>
                    </view>
                    <view class="cell m-t-10 f-s-12" wx:if="{{orderDetail.contactInfo.email}}">
                        <view class="label text-grey3">联系邮箱</view>
                        <view>{{orderDetail.contactInfo.email}}</view>
                    </view>
                    <view class="cell m-t-10 f-s-12">
                        <view class="label text-grey3">下单时间</view>
                        <view>
                            <date-format value="{{orderDetail.bookingTime}}" format="yyyy-MM-dd HH:mm" />
                        </view>
                    </view>
                </view>
                <view class="p-y-14 p-x-16 bg-white m-b-8" wx:if="{{orderDetail.distributionSummary.distribution}}">
                    <view class="f-s-14 f-w-bold">发票信息</view>
                    <view class="d-flex m-t-14 f-s-12 ">
                        <view class="text-grey3">
                            <text>报销凭证 (</text>
                            <dict-transform dict="CustomerDistStatus" code="{{ orderDetail.distributionSummary.distributionTracking.customerDistStatus|| 'WaitDist'}}" />
                            <text>)</text>
                        </view>
                        <view class="flex-1 text-primary text-right" bindtap="throttleToInvoice">
                            查看详情
                        </view>
                    </view>
                </view>
                <view class="p-y-14 p-x-16 bg-white m-b-8">
                    <view class="f-s-14 f-w-bold m-b-12">支付信息</view>
                    <view class="d-flex f-s-12">
                        <view class="text-grey3 m-r-48">支付方式</view>
                        <view>
                            <dict-transform dict="CorpPayMode" code="{{orderDetail.payMode}}"></dict-transform>
                        </view>
                    </view>
                </view>
            </view>
        </view>
    </scroll-view>
</view>
<van-popup show="{{ feeDetailVisible }}" custom-style="max-height: 70%;" round position="bottom" bind:close="throttleCloseFeeDetail" closeable>
    <view class="p-x-16 p-t-16 p-b-16 text-grey1">
        <view class="f-s-14  f-w-bold">金额明细</view>
        <view class="f-s-12 p-y-12 b-b-1 b-grey7" wx:for="{{feeGroupedByPsgType}}" wx:key="index" wx:for-item="groups">
            <view wx:if="{{isRoundTrip}}" class="f-s-14 text-primary f-w-bold">
                {{ index === 0 ? '去程' : '返程' }}
            </view>
            <block wx:for="{{groups}}" wx:key="index">
                <view class="f-w-bold m-b-4 m-t-8">
                    <dict-transform dict="FlightPassengerType" code="{{item.passengerType}}"></dict-transform>
                </view>
                <view class="d-flex align-items-center justify-content-sp-bw p-y-3">
                    <view>票面价格</view>
                    <view class="text-orange1">
                        ¥
                        <text class="f-s-16 ">{{item.fee.ticketFee}}</text>
                        x {{item.count}}
                    </view>
                </view>
                <view class="d-flex align-items-center justify-content-sp-bw p-y-3">
                    <view>机场建设费</view>
                    <view>¥ {{item.fee.airportFee}} x {{item.count}}</view>
                </view>
                <view class="d-flex align-items-center justify-content-sp-bw p-y-3">
                    <view>燃油附加费</view>
                    <view>¥ {{item.fee.oilFee}} x {{item.count}}</view>
                </view>
                <view wx:if="{{isReturnOrder}}" class="d-flex align-items-center justify-content-sp-bw p-y-3">
                    <view>退票费</view>
                    <view>¥ {{item.fee.returnTicketFee}} x {{item.count}}</view>
                </view>
                <block wx:if="{{isChangeOrder}}">
                    <view class="d-flex align-items-center justify-content-sp-bw p-y-3">
                        <view>票价补差</view>
                        <view>
                            ¥ {{ item.fee.ticketFee + item.fee.airportFee + item.fee.oilFee}} x {{item.count}}
                        </view>
                    </view>
                    <view class="d-flex align-items-center justify-content-sp-bw p-y-3">
                        <view>改签费</view>
                        <view>¥ {{item.fee.changeTicketFee}} x {{item.count}}</view>
                    </view>
                </block>
            </block>
        </view>
        <view wx:if="{{insuranceFeeVis || serviceFee}}" class="f-s-12 p-y-12 ">
            <view class="f-s-14 f-w-bold m-b-4">增值服务</view>
            <block wx:if="{{insuranceFeeVis}}">
                <view wx:for="{{insurancesInOneRoute}}" wx:for-item="insur" wx:key="index" class="d-flex align-items-center justify-content-sp-bw p-y-3">
                    <view>
                        <dict-transform code="{{insur.insuranceName}}" dict="InsuranceType"></dict-transform>
                    </view>
                    <view>
                        ¥ {{insur.totalPrice}} x {{insur.insuranceCount}}
                        <block wx:if="{{isRoundTrip}}">x 2程</block>
                    </view>
                </view>
            </block>
            <view wx:if="{{serviceFee}}" class="d-flex align-items-center justify-content-sp-bw p-y-3">
                <view>系统使用费</view>
                <view>¥ {{serviceFee}} x {{passengerCount}}</view>
            </view>
        </view>
    </view>
</van-popup>
<!-- <view>分享按钮</view>
    <button open-type="share" class="share-btn">分享给好友</button>
    <view class=""></view> -->
<loading wx:if="{{isLoading}}" title="{{loadingTitle}}" />
<bunk-policies-and-baggage routes="{{orderDetail.routes}}" visible="{{policyAndBaggageVis}}"></bunk-policies-and-baggage>